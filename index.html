<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodSync - Real Logic Calculation</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #fff1f2; color: #4a4a4a; }
        .font-eng { font-family: 'Quicksand', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.8); }
        .animate-up { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#be185d', secondary: '#fbcfe8', accent: '#8b5cf6', success: '#10b981', warning: '#f59e0b',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Heart, Utensils, Smile, BarChart2, Users, Plus, Activity, Brain, Zap, AlertTriangle, CheckCircle, RefreshCcw, Trash2 } = lucide;

        // --- 1. Database & Config ---
        const MOODS = [
            { level: 1, label: "‡πÄ‡∏®‡∏£‡πâ‡∏≤/‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î", score: 0, color: "bg-slate-400" },
            { level: 2, label: "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏•‡πâ‡∏≤", score: 25, color: "bg-blue-300" },
            { level: 3, label: "‡∏õ‡∏Å‡∏ï‡∏¥", score: 50, color: "bg-yellow-400" },
            { level: 4, label: "‡∏™‡∏î‡πÉ‡∏™", score: 75, color: "bg-orange-400" },
            { level: 5, label: "‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç", score: 100, color: "bg-rose-500" }
        ];

        const NUTRIENTS = [
            { id: 'probiotic', name: 'Probiotics', score: 10, type: 'good', desc: '‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏•‡∏≥‡πÑ‡∏™‡πâ' },
            { id: 'b6b12', name: 'Vit B6/B12', score: 5, type: 'good', desc: '‡∏™‡∏£‡πâ‡∏≤‡∏á Serotonin' },
            { id: 'magnesium', name: 'Magnesium', score: 5, type: 'good', desc: '‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î' },
            { id: 'lowgi', name: 'Low GI', score: 5, type: 'good', desc: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà' },
            { id: 'sugar', name: 'High Sugar', score: -15, type: 'bad', desc: 'Sugar Crash' },
            { id: 'greasy', name: 'High Fat/Greasy', score: -5, type: 'bad', desc: '‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏≤‡∏Å' }
        ];

        const GUT_STATUS = [
            { id: 'good', label: '‡∏™‡∏ö‡∏≤‡∏¢‡∏ó‡πâ‡∏≠‡∏á', score: 10 },
            { id: 'normal', label: '‡∏õ‡∏Å‡∏ï‡∏¥', score: 0 },
            { id: 'bloated', label: '‡∏ó‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡∏î', score: -10 },
            { id: 'constipated', label: '‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å', score: -10 }
        ];

        // --- 2. Logic Engines (The Core Calculations) ---
        
        // A. Food-Mood Index Algorithm
        const calculateHealthIndex = (logs) => {
            if (!logs || logs.length === 0) return 50; // Default start

            let totalScore = 0;
            logs.forEach(log => {
                // 1. Base Mood Score (0-100)
                let logScore = MOODS.find(m => m.level === log.mood)?.score || 50;

                // 2. Nutrient Impact
                log.nutrients.forEach(nid => {
                    const nutrient = NUTRIENTS.find(n => n.id === nid);
                    if (nutrient) logScore += nutrient.score;
                });

                // 3. Gut Impact
                const gut = GUT_STATUS.find(g => g.id === log.gutStatus);
                if (gut) logScore += gut.score;

                totalScore += logScore;
            });

            // Average and Clamp between 0-100
            const average = totalScore / logs.length;
            return Math.min(100, Math.max(0, Math.round(average)));
        };

        // B. Nutritional Prescription Engine (Rule-based AI)
        const generatePrescription = (lastLog) => {
            if (!lastLog) return {
                title: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•",
                text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏∑‡πâ‡∏≠‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
                food: "‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤, ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏™‡∏î",
                tag: "Start"
            };

            const { mood, gutStatus, nutrients } = lastLog;
            const hasSugar = nutrients.includes('sugar');

            // Rule 1: Gut Issue Priority
            if (gutStatus === 'bloated' || gutStatus === 'constipated') {
                return {
                    title: "‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏•‡∏≥‡πÑ‡∏™‡πâ‡∏î‡πà‡∏ß‡∏ô (Gut-First)",
                    text: "‡∏•‡∏≥‡πÑ‡∏™‡πâ‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå‡∏î‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå",
                    food: "‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï, ‡∏Å‡∏¥‡∏°‡∏à‡∏¥, ‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠",
                    tag: "Gut Health"
                };
            }

            // Rule 2: Sugar Crash Prevention
            if (hasSugar && mood <= 3) {
                return {
                    title: "‡πÅ‡∏Å‡πâ Sugar Crash",
                    text: "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≤‡∏ô‡∏´‡∏ß‡∏≤‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏¥‡πà‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏´‡∏£‡∏∑‡∏≠ Low GI",
                    food: "‡∏ñ‡∏±‡πà‡∏ß‡∏≠‡∏±‡∏•‡∏°‡∏≠‡∏ô‡∏î‡πå, ‡πÑ‡∏Ç‡πà‡∏ï‡πâ‡∏°",
                    tag: "Balance"
                };
            }

            // Rule 3: Low Mood (Serotonin Boost)
            if (mood <= 2) {
                return {
                    title: "Boost Serotonin",
                    text: "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏π‡∏´‡∏°‡πà‡∏ô‡∏´‡∏°‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° Tryptophan ‡πÅ‡∏•‡∏∞ B6 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç",
                    food: "‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï, ‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏´‡∏≠‡∏°",
                    tag: "Mood Lift"
                };
            }

            // Rule 4: High Stress/Anxiety (Magnesium)
            if (mood === 1) { // Assuming 1 is stressed/sad
                return {
                    title: "‡∏•‡∏î Cortisol (‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î)",
                    text: "‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏°‡∏Å‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢‡∏°",
                    food: "‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°, ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ü‡∏±‡∏Å‡∏ó‡∏≠‡∏á",
                    tag: "Relax"
                };
            }

            // Default: Maintenance
            return {
                title: "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏• (Maintenance)",
                text: "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÑ‡∏õ",
                food: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà‡∏£‡∏ß‡∏°, ‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô",
                tag: "Excellent"
            };
        };

        // C. Risk Assessment Logic
        const assessRisk = (logs) => {
            if (logs.length < 3) return { status: "Wait", text: "‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°...", color: "text-gray-500", bg: "bg-gray-100" };
            
            const recentLogs = logs.slice(0, 7); // Analyze last 7 entries
            const lowMoodCount = recentLogs.filter(l => l.mood <= 2).length;
            const riskPercentage = (lowMoodCount / recentLogs.length) * 100;

            if (riskPercentage > 50) {
                return { status: "High Risk", text: "‡∏û‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç", color: "text-red-600", bg: "bg-red-50" };
            } else if (riskPercentage > 25) {
                return { status: "Moderate", text: "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£", color: "text-orange-600", bg: "bg-orange-50" };
            } else {
                return { status: "Normal", text: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ", color: "text-green-600", bg: "bg-green-50" };
            }
        };


        // --- 3. Components ---

        const Dashboard = ({ logs, hrv }) => {
            const lastLog = logs[0];
            const prescription = useMemo(() => generatePrescription(lastLog), [lastLog]);
            const risk = useMemo(() => assessRisk(logs), [logs]);

            return (
                <div className="p-6 pb-24 space-y-5 animate-up">
                    <header className="flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800">MoodSync AI</h1>
                            <p className="text-xs text-gray-500">Live Monitor & Analytics</p>
                        </div>
                        <div className="bg-rose-100 p-2 rounded-full text-primary font-bold">{logs.length} Log</div>
                    </header>

                    {/* Live Bio-Feedback (Real Simulation) */}
                    <div className="bg-gray-900 rounded-3xl p-5 text-white shadow-xl relative overflow-hidden">
                        <div className="flex justify-between items-start">
                            <div className="flex items-center gap-2">
                                <span className="relative flex h-3 w-3">
                                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
                                  <span className="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span>
                                </span>
                                <span className="text-[10px] uppercase tracking-widest text-gray-400">Live HRV</span>
                            </div>
                            <Heart size={20} className="text-rose-500 animate-pulse" />
                        </div>
                        <div className="mt-4 flex items-end gap-2">
                            <span className="text-5xl font-bold font-eng">{hrv}</span>
                            <span className="text-sm text-gray-400 mb-2">ms</span>
                        </div>
                        <div className="mt-2 h-1 bg-gray-800 rounded overflow-hidden">
                             <div className="h-full bg-gradient-to-r from-green-400 to-rose-500 transition-all duration-500" style={{width: `${Math.min(100, (hrv/100)*100)}%`}}></div>
                        </div>
                        <p className="text-[10px] text-gray-500 mt-2 text-right">Updated: Real-time simulation</p>
                    </div>

                    {/* Dynamic Prescription */}
                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-rose-100 relative">
                        <div className="flex items-center gap-2 mb-3">
                            <div className="bg-rose-50 p-2 rounded-lg text-primary"><Brain size={18} /></div>
                            <h3 className="font-bold text-gray-700">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì</h3>
                        </div>
                        <div className="space-y-2">
                             <h4 className="text-lg font-bold text-primary">{prescription.title}</h4>
                             <p className="text-sm text-gray-600">{prescription.text}</p>
                             <div className="mt-3 bg-rose-50 p-3 rounded-xl border border-rose-100 flex items-center gap-3">
                                <span className="text-2xl">ü•ó</span>
                                <div>
                                    <span className="text-xs font-bold text-rose-400 uppercase">Recommended</span>
                                    <p className="font-bold text-gray-700 text-sm">{prescription.food}</p>
                                </div>
                             </div>
                        </div>
                    </div>

                    {/* Risk Status */}
                    <div className={`rounded-2xl p-4 flex items-center gap-4 ${risk.bg}`}>
                        <div className={`p-2 rounded-full bg-white ${risk.color}`}><Activity size={20} /></div>
                        <div>
                            <p className="text-xs font-bold uppercase opacity-70">Mental Risk Screen</p>
                            <p className={`font-bold text-sm ${risk.color}`}>{risk.status}</p>
                            <p className="text-[10px] opacity-70">{risk.text}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Logger = ({ onSave }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState({ mood: 3, food: '', nutrients: [], gutStatus: 'normal' });

            const toggleNutrient = (id) => {
                setData(prev => ({
                    ...prev, nutrients: prev.nutrients.includes(id) ? prev.nutrients.filter(n => n !== id) : [...prev.nutrients, id]
                }));
            };

            return (
                <div className="h-full bg-white flex flex-col p-6 animate-up">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
                        <span className="text-xs bg-gray-100 px-2 py-1 rounded">Step {step}/3</span>
                    </div>

                    <div className="flex-1 overflow-y-auto hide-scrollbar pb-20">
                        {step === 1 && (
                            <div className="space-y-6">
                                <p className="text-center text-gray-500">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</p>
                                <div className="grid grid-cols-5 gap-2">
                                    {MOODS.map(m => (
                                        <button key={m.level} onClick={() => setData({...data, mood: m.level})} 
                                            className={`flex flex-col items-center p-2 rounded-xl transition-all ${data.mood === m.level ? 'bg-rose-50 ring-2 ring-primary scale-110' : 'opacity-60'}`}>
                                            <div className={`w-10 h-10 rounded-full ${m.color} mb-1`}></div>
                                            <span className="text-[10px] font-bold">{m.label}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="pt-6 border-t">
                                    <p className="text-center text-gray-500 mb-4">‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡∏≥‡πÑ‡∏™‡πâ (Gut Check)</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        {GUT_STATUS.map(g => (
                                            <button key={g.id} onClick={() => setData({...data, gutStatus: g.id})}
                                                className={`p-3 border rounded-xl text-sm ${data.gutStatus === g.id ? 'border-primary bg-rose-50 text-primary font-bold' : 'text-gray-500'}`}>
                                                {g.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-4">
                                <input type="text" placeholder="‡∏ó‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤..." className="w-full p-4 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary"
                                    value={data.food} onChange={e => setData({...data, food: e.target.value})} />
                                <p className="text-sm font-bold text-gray-600">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Smart Log)</p>
                                {NUTRIENTS.map(n => (
                                    <button key={n.id} onClick={() => toggleNutrient(n.id)}
                                        className={`w-full p-3 rounded-xl border flex justify-between items-center ${data.nutrients.includes(n.id) ? (n.type === 'good' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700') : 'bg-white text-gray-500'}`}>
                                        <div className="text-left">
                                            <span className="font-bold text-sm block">{n.name}</span>
                                            <span className="text-[10px]">{n.desc}</span>
                                        </div>
                                        {data.nutrients.includes(n.id) && <CheckCircle size={16} />}
                                    </button>
                                ))}
                            </div>
                        )}

                        {step === 3 && (
                            <div className="text-center pt-10">
                                <div className="text-6xl mb-4">üìä</div>
                                <h3 className="text-xl font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?</h3>
                                <div className="bg-gray-50 p-4 rounded-xl mt-4 text-left space-y-2">
                                    <p><strong>‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå:</strong> {MOODS.find(m => m.level === data.mood).label}</p>
                                    <p><strong>‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</strong> {data.food || "-"}</p>
                                    <p><strong>‡∏•‡∏≥‡πÑ‡∏™‡πâ:</strong> {GUT_STATUS.find(g => g.id === data.gutStatus).label}</p>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-24 left-6 right-6 flex gap-2">
                        {step > 1 && <button onClick={() => setStep(step-1)} className="px-6 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">‡∏Å‡∏•‡∏±‡∏ö</button>}
                        <button onClick={() => step < 3 ? setStep(step+1) : onSave(data)} 
                            className="flex-1 py-3 bg-primary text-white rounded-xl font-bold shadow-lg shadow-rose-200">
                            {step < 3 ? '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'}
                        </button>
                    </div>
                </div>
            );
        };

        const Insights = ({ logs, onClear }) => {
            const score = useMemo(() => calculateHealthIndex(logs), [logs]);

            return (
                <div className="p-6 pb-24 space-y-6 animate-up">
                    <div className="flex justify-between items-end">
                        <h2 className="text-2xl font-bold text-gray-800">‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
                        <button onClick={onClear} className="text-xs text-red-400 flex items-center gap-1"><Trash2 size={12}/> Reset Data</button>
                    </div>

                    {/* Real Calculated Gauge */}
                    <div className="bg-white p-6 rounded-3xl shadow-sm border border-rose-100 text-center relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1 bg-gray-100">
                            <div className="h-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-500" style={{width: `${score}%`}}></div>
                        </div>
                        <p className="text-gray-400 text-xs uppercase tracking-widest mb-2">Food-Mood Index</p>
                        <h3 className="text-6xl font-bold text-primary font-eng mb-2">{score}</h3>
                        <p className="text-sm text-gray-500">
                            {score > 80 ? "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏î‡∏µ" : 
                             score > 50 ? "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•" : 
                             "‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á! ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≤‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå"}
                        </p>
                    </div>

                    {/* Timeline with Real Impact Indicators */}
                    <div className="space-y-3">
                        <h3 className="font-bold text-gray-700 text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Timeline)</h3>
                        {logs.length === 0 ? <p className="text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p> : 
                        logs.map((log, i) => {
                            const moodObj = MOODS.find(m => m.level === log.mood);
                            return (
                                <div key={log.id} className="bg-white p-3 rounded-2xl flex items-center gap-3 border border-gray-50 shadow-sm">
                                    <div className={`w-10 h-10 rounded-full ${moodObj.color} flex items-center justify-center text-white text-xs`}>
                                        {log.mood}/5
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="font-bold text-sm truncate">{log.food || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}</p>
                                        <div className="flex gap-1 mt-1">
                                            {log.nutrients.map(n => (
                                                <span key={n} className={`w-2 h-2 rounded-full ${NUTRIENTS.find(x=>x.id===n)?.type === 'good' ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-[10px] text-gray-400">{new Date(log.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- 4. Main App & State Management ---

        const App = () => {
            const [tab, setTab] = useState('dash');
            const [logs, setLogs] = useState([]);
            const [hrv, setHrv] = useState(65); // Initial HRV

            // Load Data
            useEffect(() => {
                const saved = localStorage.getItem('moodsync_real_db');
                if (saved) setLogs(JSON.parse(saved));
            }, []);

            // Live Bio-Feedback Simulation Effect
            useEffect(() => {
                const interval = setInterval(() => {
                    // Randomly fluctuate HRV based on "Stress" simulation
                    setHrv(prev => {
                        const change = Math.floor(Math.random() * 5) - 2; // -2 to +2
                        return Math.max(40, Math.min(100, prev + change));
                    });
                }, 2000); // Update every 2 seconds
                return () => clearInterval(interval);
            }, []);

            const saveLog = (data) => {
                const newLog = { 
                    ...data, 
                    id: Date.now(), 
                    timestamp: new Date().toISOString() 
                };
                const updated = [newLog, ...logs];
                setLogs(updated);
                localStorage.setItem('moodsync_real_db', JSON.stringify(updated));
                setTab('dash');
            };

            const clearData = () => {
                if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                    setLogs([]);
                    localStorage.removeItem('moodsync_real_db');
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fff1f2] relative shadow-2xl overflow-hidden flex flex-col">
                    <main className="flex-1 relative z-10">
                        {tab === 'dash' && <Dashboard logs={logs} hrv={hrv} />}
                        {tab === 'log' && <Logger onSave={saveLog} />}
                        {tab === 'insight' && <Insights logs={logs} onClear={clearData} />}
                    </main>

                    {/* Bottom Nav */}
                    <div className="glass-panel fixed bottom-0 w-full max-w-md flex justify-around py-3 pb-6 rounded-t-3xl z-50">
                        <button onClick={() => setTab('dash')} className={`flex flex-col items-center ${tab==='dash'?'text-primary scale-110':'text-gray-400'}`}>
                            <Activity size={24} /><span className="text-[10px] mt-1">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
                        </button>
                        <button onClick={() => setTab('log')} className="-mt-8 bg-primary text-white p-4 rounded-full shadow-lg shadow-rose-300 transform transition hover:scale-105">
                            <Plus size={28} />
                        </button>
                        <button onClick={() => setTab('insight')} className={`flex flex-col items-center ${tab==='insight'?'text-primary scale-110':'text-gray-400'}`}>
                            <BarChart2 size={24} /><span className="text-[10px] mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


